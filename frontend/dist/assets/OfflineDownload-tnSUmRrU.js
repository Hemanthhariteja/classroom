import{r as c,j as e,c as L,e as P}from"./index-D9lXXRMH.js";import{g as U,l as S,c as R,a as E}from"./offline-D748ZU6k.js";function A({packageId:d,onClose:m}){var v,t,o,x,N;const[f,r]=c.useState(null),[n,h]=c.useState(0),[y,u]=c.useState(!0),[g,j]=c.useState(null);c.useEffect(()=>{b()},[d]);const b=async()=>{try{u(!0),console.log("[OfflineViewer] Loading package:",d);const l=await U(d);if(console.log("[OfflineViewer] Package loaded:",l),!l){j("Package not found");return}l.slides&&(l.slides=l.slides.map(s=>{var i;if(console.log("[OfflineViewer] Processing slide:",s),s.blob&&(!s.url||s.url.startsWith("blob:")))if(s.blob.type==="application/pdf"||(i=s.filename)!=null&&i.match(/\.pdf$/i)){const p=new Blob([s.blob],{type:"application/pdf"});s.url=URL.createObjectURL(p),console.log("[OfflineViewer] Recreated PDF blob URL:",s.url)}else s.url=URL.createObjectURL(s.blob),console.log("[OfflineViewer] Recreated blob URL:",s.url);if(!s.type&&s.filename){const p=s.filename.split(".").pop().toLowerCase();["jpg","jpeg","png","gif","webp"].includes(p)?s.type="image":["pdf"].includes(p)?s.type="pdf":s.type="unknown"}return!s.type&&s.blob&&s.blob.type&&(s.blob.type.startsWith("image/")?s.type="image":s.blob.type==="application/pdf"?s.type="pdf":s.type="unknown"),console.log("[OfflineViewer] Slide after processing:",s),s})),l.audioFiles&&(l.audioFiles=l.audioFiles.map(s=>(console.log("[OfflineViewer] Processing audio:",s),s.blob&&(!s.url||s.url.startsWith("blob:"))&&(s.url=URL.createObjectURL(s.blob),console.log("[OfflineViewer] Recreated audio blob URL:",s.url)),s))),r(l)}catch(l){console.error("[OfflineViewer] Error loading package:",l),j("Failed to load offline package: "+l.message)}finally{u(!1)}};if(y)return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",children:e.jsx("div",{className:"card p-6 max-w-md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-accent border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{children:"Loading offline content..."})]})})});if(g)return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",children:e.jsx("div",{className:"card p-6 max-w-md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Error"}),e.jsx("p",{className:"text-red-400 mb-4",children:g}),e.jsx("button",{className:"btn",onClick:m,children:"Close"})]})})});if(!f)return null;const a=f.slides||[],w=f.audioFiles||[];return e.jsxs("div",{className:"fixed inset-0 bg-black/90 z-50",children:[e.jsxs("div",{className:"bg-card border-b border-border p-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:f.name}),e.jsxs("p",{className:"text-sm text-textMuted",children:["ðŸ“± Offline Mode â€¢ ",a.length," slides â€¢ ",w.length," audio files"]})]}),e.jsx("button",{className:"btn-ghost",onClick:m,title:"Close offline viewer",children:"âœ• Close"})]}),e.jsxs("div",{className:"flex h-[calc(100vh-80px)]",children:[e.jsxs("div",{className:"flex-1 p-4",children:[a.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:a.map((l,s)=>{var i,p,k,F,O,D,C;return e.jsx("button",{onClick:()=>h(s),className:`flex-shrink-0 border rounded overflow-hidden ${s===n?"ring-2 ring-accent":"border-border"}`,children:l.type==="image"||(i=l.filename)!=null&&i.match(/\.(jpg|jpeg|png|gif|webp)$/i)||(k=(p=l.blob)==null?void 0:p.type)!=null&&k.startsWith("image/")?e.jsx("img",{src:l.url,alt:l.title||l.filename,className:"w-20 h-16 object-cover"}):l.type==="pdf"||(F=l.filename)!=null&&F.match(/\.pdf$/i)||((O=l.blob)==null?void 0:O.type)==="application/pdf"?e.jsx("div",{className:"w-20 h-16 bg-red-100 flex items-center justify-center",children:e.jsx("span",{className:"text-red-600 text-xs font-bold",children:"PDF"})}):e.jsx("div",{className:"w-20 h-16 bg-gray-100 flex items-center justify-center",children:e.jsx("span",{className:"text-gray-600 text-xs",children:((C=(D=l.filename)==null?void 0:D.split(".").pop())==null?void 0:C.toUpperCase())||"FILE"})})},s)})}),e.jsxs("p",{className:"text-xs text-textMuted mt-2",children:["Slide ",n+1," of ",a.length," â€¢ Use â† â†’ keys to navigate"]})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center bg-gray-900 rounded border border-border min-h-[400px]",children:a.length>0&&a[n]?e.jsx("div",{className:"max-w-full max-h-full",children:a[n].type==="image"||(v=a[n].filename)!=null&&v.match(/\.(jpg|jpeg|png|gif|webp)$/i)||(o=(t=a[n].blob)==null?void 0:t.type)!=null&&o.startsWith("image/")?e.jsx("img",{src:a[n].url,alt:a[n].title||a[n].filename,className:"max-w-full max-h-[70vh] object-contain rounded",onError:l=>{console.error("[OfflineViewer] Image load error:",l),console.log("[OfflineViewer] Failed slide data:",a[n])}}):a[n].type==="pdf"||(x=a[n].filename)!=null&&x.match(/\.pdf$/i)||((N=a[n].blob)==null?void 0:N.type)==="application/pdf"?e.jsxs("div",{className:"w-full h-[70vh]",children:[e.jsx("iframe",{src:a[n].url,className:"w-full h-full border-0 rounded",title:a[n].title||a[n].filename||"PDF Document",type:"application/pdf",onError:l=>{console.error("[OfflineViewer] PDF load error:",l),console.log("[OfflineViewer] Failed PDF data:",a[n])}}),e.jsxs("div",{className:"text-center p-4 mt-2",children:[e.jsx("button",{className:"btn mr-2",onClick:()=>{window.open(a[n].url,"_blank")},children:"ðŸ“– Try to Open PDF"}),e.jsx("button",{className:"btn",onClick:()=>{const l=document.createElement("a");l.href=a[n].url,l.download=a[n].filename||"document.pdf",l.click()},children:"ðŸ’¾ Download PDF"})]})]}):e.jsxs("div",{className:"text-center p-8 text-textMuted",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“„"}),e.jsxs("p",{className:"mb-2",children:["File: ",a[n].filename||"Unknown"]}),e.jsxs("p",{className:"mb-2",children:["Type: ",a[n].type||"Unknown"]}),e.jsxs("p",{className:"mb-4",children:["Extension: ",a[n].extension||"Unknown"]}),a[n].blob&&e.jsxs("p",{className:"mb-4",children:["Blob Type: ",a[n].blob.type]}),e.jsx("p",{className:"text-sm",children:"This file type is not yet supported for offline viewing."}),a[n].url&&e.jsx("button",{className:"btn mt-4",onClick:()=>{window.open(a[n].url,"_blank")},children:"ðŸ”— Try to Open File"})]})}):e.jsxs("div",{className:"text-center text-textMuted",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“š"}),e.jsx("p",{children:"No slides available in this offline package"})]})})]}),w.length>0&&e.jsxs("div",{className:"w-80 bg-card border-l border-border p-4",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"ðŸŽµ Audio Files"}),e.jsx("div",{className:"space-y-4",children:w.map((l,s)=>{var i;return e.jsxs("div",{className:"border border-border rounded p-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:l.title}),e.jsxs("audio",{controls:!0,className:"w-full",children:[e.jsx("source",{src:l.url,type:l.type}),"Your browser does not support the audio element."]}),e.jsxs("div",{className:"text-xs text-textMuted mt-1",children:[(i=l.extension)==null?void 0:i.toUpperCase()," â€¢ Slide ",l.slideIndex]})]},s)})})]})]}),e.jsx("div",{className:"hidden",children:e.jsx(M,{onLeft:()=>h(Math.max(0,n-1)),onRight:()=>h(Math.min(a.length-1,n+1))})})]})}function M({onLeft:d,onRight:m}){return c.useEffect(()=>{const f=r=>{r.key==="ArrowLeft"?(r.preventDefault(),d()):r.key==="ArrowRight"&&(r.preventDefault(),m())};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[d,m]),null}function I(){const[d,m]=c.useState([]),[f,r]=c.useState(""),[n,h]=c.useState([]),[y,u]=c.useState(!1),[g,j]=c.useState(null);c.useEffect(()=>{b(),a()},[]);async function b(){try{console.log("[OfflineDownload] Loading saved packages...");const t=await S();console.log("[OfflineDownload] Found packages:",t),m(t||[])}catch(t){console.error("[OfflineDownload] Error loading packages:",t),m([])}}async function a(){try{const o=await L.get("/classes/68cced26157d87e24fee03ce");o.status==="ok"&&o.class&&h([o.class])}catch(t){console.error("Failed to load classes:",t)}}const w=async t=>{u(!0),r("Downloading files...");try{const o=async l=>{const s=await fetch(l);if(!s.ok)throw new Error(`Failed to download ${l}`);return await s.blob()},x=[];for(const l of t.slides||[])try{const s=`http://localhost:3000/storage/${l.filename}`,i=await o(s);x.push({filename:l.filename,blob:i,type:i.type,url:URL.createObjectURL(i)}),r(`Downloaded: ${l.filename}`)}catch(s){console.error(`Failed to download slide ${l.filename}:`,s)}const N=[];for(const l of t.slideAudio||[])try{const s=`http://localhost:3000/storage/${l.audioFile}`,i=await o(s);N.push({filename:l.audioFile.split("/").pop(),blob:i,type:i.type,url:URL.createObjectURL(i),slideIndex:l.slideIndex}),r(`Downloaded: ${l.audioFile}`)}catch(s){console.error(`Failed to download audio ${l.audioFile}:`,s)}await E({id:`class-${t.id}`,classId:t.id,name:t.title||"Untitled Class",slides:x,audioFiles:N,downloadedAt:new Date().toISOString(),manifest:t}),r("Saved for offline!"),b()}catch(o){console.error("Download failed:",o),r("Download failed. Please try again.")}finally{u(!1)}},v=async t=>{try{console.log("[OfflineDownload] Opening package viewer for:",t),j(t)}catch(o){console.error("[OfflineDownload] Failed to open package viewer:",o),alert("Failed to open offline package: "+o.message)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:"btn-ghost",onClick:()=>window.history.back(),children:"â† Back to Dashboard"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Offline Download"})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("section",{className:"card p-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Available Classes"}),e.jsx("p",{className:"text-sm text-textMuted mb-3",children:"Download classes for offline access"}),n.length>0?e.jsx("div",{className:"space-y-3",children:n.map(t=>e.jsx("div",{className:"border border-border rounded p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:t.title||"Untitled Class"}),e.jsxs("div",{className:"text-xs text-textMuted",children:[(t.slides||[]).length," slides â€¢ ",(t.slideAudio||[]).length," audio files"]})]}),e.jsx("button",{className:"btn",onClick:()=>w(t),disabled:y,children:y?"Downloading...":"Download"})]})},t.id))}):e.jsx("div",{className:"text-sm text-textMuted",children:"No classes available for download"}),f&&e.jsx("p",{className:"text-sm text-textMuted mt-3",children:f})]}),e.jsxs("section",{className:"card p-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Saved Packages"}),e.jsxs("div",{className:"mb-3 flex gap-2",children:[e.jsx("button",{className:"btn-ghost text-xs",onClick:()=>{console.log("[OfflineDownload] Current packages:",d),b()},children:"ðŸ”„ Refresh"}),e.jsx("button",{className:"btn-ghost text-xs",onClick:async()=>{if(confirm("Clear all saved packages?"))try{await R(),console.log("[OfflineDownload] Cleared all packages"),await b(),r("All packages cleared")}catch(t){console.error("Failed to clear packages:",t),r("Failed to clear packages")}},children:"ðŸ—‘ï¸ Clear All"})]}),e.jsxs("ul",{className:"space-y-2",children:[d.map(t=>{const o=t.slides?t.slides.length:0,x=t.audioFiles?t.audioFiles.length:t.audioKeys?t.audioKeys.length:0;return e.jsxs("li",{className:"flex items-center justify-between border border-border rounded px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:t.name||"Unnamed Package"}),e.jsxs("div",{className:"text-xs text-textMuted",children:[o," slides â€¢ ",x," audio files"]}),t.downloadedAt&&e.jsxs("div",{className:"text-xs text-textMuted",children:["Downloaded: ",new Date(t.downloadedAt).toLocaleDateString()]}),e.jsxs("div",{className:"text-xs text-gray-400",children:["ID: ",t.id]})]}),e.jsx("button",{className:"btn",onClick:()=>v(t.id),children:"Play"})]},t.id)}),!d.length&&e.jsx("li",{className:"text-sm text-textMuted",children:"No packages saved. Download a class to get started!"})]})]})]}),g&&e.jsx(A,{packageId:g,onClose:()=>j(null)}),e.jsx(P,{})]})}export{I as default};
