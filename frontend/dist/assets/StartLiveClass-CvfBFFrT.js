import{u as D,f as R,r,j as e,g as P,c as w,_}from"./index-D9lXXRMH.js";function W(){const{id:l}=D();R();const[b,h]=r.useState([]),[g,v]=r.useState([]),[a,n]=r.useState("");r.useEffect(()=>{h([{id:1,name:"Student A",phone:"8765432109",status:"online",joinedAt:new Date},{id:2,name:"Student B",phone:"7654321098",status:"online",joinedAt:new Date},{id:3,name:"Student C",phone:"6543210987",status:"viewing",joinedAt:new Date}]),v([{id:1,sender:"Student A",message:"Can you repeat the last slide?",time:new Date},{id:2,sender:"Student B",message:"Audio is clear, thank you!",time:new Date}])},[l]);const j=()=>{if(a.trim()){const s={id:Date.now(),sender:"Teacher",message:a,time:new Date};v(o=>[...o,s]),n("")}},m=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),j())};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Live Class Monitor"}),e.jsxs("div",{className:"card p-4",children:[e.jsxs("h4",{className:"font-medium mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live Students (",b.length,")"]}),e.jsx("div",{className:"space-y-2",children:b.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-background rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:s.name}),e.jsxs("span",{className:"text-xs text-textMuted ml-2",children:["(",s.phone,")"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:`text-xs px-2 py-1 rounded ${s.status==="online"?"bg-green-100 text-green-700":s.status==="viewing"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:s.status})})]},s.id))})]}),e.jsxs("div",{className:"card p-4",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Student Messages"}),e.jsxs("div",{className:"space-y-2 max-h-64 overflow-y-auto mb-3",children:[g.map(s=>e.jsxs("div",{className:`p-2 rounded ${s.sender==="Teacher"?"bg-blue-100 dark:bg-blue-900/20 ml-8":"bg-gray-100 dark:bg-gray-800 mr-8"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium",children:s.sender}),e.jsx("span",{className:"text-xs text-textMuted",children:s.time.toLocaleTimeString()})]}),e.jsx("p",{className:"text-sm",children:s.message})]},s.id)),g.length===0&&e.jsx("p",{className:"text-textMuted text-center py-4",children:"No messages yet"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:a,onChange:s=>n(s.target.value),onKeyPress:m,placeholder:"Send message to students...",className:"flex-1 px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary"}),e.jsx("button",{onClick:j,disabled:!a.trim(),className:"btn px-4",children:"Send"})]})]}),e.jsxs("div",{className:"card p-4",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Class Controls"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-2",children:[e.jsx("button",{className:"btn",children:"üì¢ Send Announcement"}),e.jsx("button",{className:"btn",children:"üìä Take Attendance"}),e.jsx("button",{className:"btn",children:"‚ùì Start Poll"}),e.jsx("button",{className:"btn",children:"üìù Share Note"})]})]})]})}function q(){const{id:l}=D(),b=P();R();const[h,g]=r.useState(!1),[v,a]=r.useState("Ready to start live class"),[n,j]=r.useState(null),[m,s]=r.useState(!1),[o,C]=r.useState(null),[f,L]=r.useState("prompt"),[M,N]=r.useState(!1),[$,k]=r.useState(0);r.useEffect(()=>{(async()=>{if(l)try{s(!0);const c=await w.get(`/classes/${l}`);console.log("[StartLiveClass] API response:",c);const i=c.class||c;j(i),a(`Class loaded: ${i.title||i.subject||"Unknown Class"}`)}catch(c){console.error("[StartLiveClass] Error loading class:",c),a("Error loading class data")}finally{s(!1)}})()},[l]),r.useEffect(()=>()=>{o&&o.getTracks().forEach(t=>t.stop())},[o]);const A=async()=>{try{a("Requesting microphone access...");const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});C(t),L("granted"),a("Microphone access granted");const c=new AudioContext,i=c.createMediaStreamSource(t),d=c.createAnalyser();i.connect(d);const p=new Uint8Array(d.frequencyBinCount),u=()=>{d.getByteFrequencyData(p);const S=p.reduce((y,x)=>y+x)/p.length;k(Math.round(S)),M&&requestAnimationFrame(u)};return u(),t}catch(t){throw console.error("[StartLiveClass] Microphone access denied:",t),L("denied"),a("Microphone access denied: "+t.message),t}},E=()=>{o&&(o.getTracks().forEach(t=>t.stop()),C(null),N(!1),k(0),a("Microphone stopped"))},B=async()=>{try{s(!0),a("Starting live broadcast...");let t=o;t||(t=await A());const c=await w.post(`/classes/${l}/start-live`);console.log("[StartLiveClass] Live broadcast started:",c),g(!0),N(!0);const i=(n==null?void 0:n.title)||(n==null?void 0:n.subject)||"class";a(`üî¥ LIVE: Broadcasting ${i} with microphone!`);try{const d="ws://localhost:3000/ws",p="";console.log("[StartLiveClass] Starting WebRTC broadcast to:",d);const u=confirm("Do you want to share your screen along with audio?");console.log("[StartLiveClass] User chose screen sharing:",u);const{startFacultyBroadcast:S}=await _(async()=>{const{startFacultyBroadcast:x}=await import("./webRTCClient-V0-wP40F.js");return{startFacultyBroadcast:x}},[]),y=await S({wsUrl:d,token:p,classId:l,includeScreen:u,onEvent:x=>{console.log("[StartLiveClass] WebRTC event:",x),a(`WebRTC: ${x}`)}});window.webrtcController=y,a(`üî¥ LIVE: Broadcasting ${i} via WebRTC ${u?"(Screen + Audio)":"(Audio Only)"}!`)}catch(d){console.error("[StartLiveClass] WebRTC setup failed:",d),a(`‚ö†Ô∏è LIVE: Broadcasting ${i} (WebRTC failed: ${d.message})`)}}catch(t){console.error("[StartLiveClass] Error starting broadcast:",t),a("Failed to start live broadcast: "+t.message)}finally{s(!1)}},I=async()=>{try{if(s(!0),a("Stopping live broadcast..."),E(),window.webrtcController)try{window.webrtcController.stop(),window.webrtcController=null,console.log("[StartLiveClass] WebRTC broadcast stopped")}catch(c){console.error("[StartLiveClass] Error stopping WebRTC:",c)}const t=await w.post(`/classes/${l}/stop-live`);console.log("[StartLiveClass] Live broadcast stopped successfully:",(t==null?void 0:t.message)||"OK"),g(!1),N(!1),a("Live broadcast stopped")}catch(t){console.error("[StartLiveClass] Error stopping broadcast:",t),a("Failed to stop live broadcast")}finally{s(!1)}},T=()=>{b("/dashboard")};return m&&!n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:"btn-ghost",onClick:T,children:"‚Üê Back to Dashboard"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Go Live"})]}),e.jsxs("div",{className:"max-w-xl mx-auto card p-6 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-2 text-textMuted",children:"Loading class data..."})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:"btn-ghost",onClick:T,children:"‚Üê Back to Dashboard"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Go Live"})]}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Go Live (Audio + Slides)"}),e.jsx("p",{className:"text-textMuted mb-3",children:"Start an audio-only broadcast. Slides are shared separately."}),n&&e.jsxs("div",{className:"mb-4 p-3 bg-background rounded border",children:[e.jsx("h3",{className:"font-medium",children:n.subject}),e.jsx("p",{className:"text-sm text-textMuted",children:n.description}),e.jsxs("p",{className:"text-xs text-textMuted mt-1",children:["Class ID: ",n._id]})]}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 dark:bg-gray-800/50 rounded border",children:[e.jsxs("h4",{className:"font-medium mb-2 flex items-center gap-2",children:["üé§ Microphone Setup",f==="granted"&&e.jsx("span",{className:"text-xs px-2 py-1 bg-green-100 text-green-700 dark:bg-green-900/20 dark:text-green-300 rounded",children:"Ready"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("button",{className:"btn btn-sm",onClick:A,disabled:f==="granted"||m,children:f==="granted"?"‚úì Mic Ready":"Test Microphone"}),o&&e.jsx("button",{className:"btn-ghost btn-sm",onClick:E,disabled:m,children:"Stop Mic"})]}),M&&e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"text-xs text-textMuted mb-1",children:"Audio Level:"}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:"bg-green-500 h-2 rounded-full transition-all duration-100",style:{width:`${Math.min($,100)}%`}})})]}),f==="denied"&&e.jsx("p",{className:"text-xs text-red-600 dark:text-red-400",children:"Microphone access denied. Please enable microphone in browser settings."})]}),e.jsx("div",{className:"flex gap-2 mb-4",children:h?e.jsx("button",{className:"btn btn-danger flex-1",onClick:I,children:"Stop Live"}):e.jsx("button",{className:"btn flex-1",onClick:B,disabled:m,children:m?"Starting...":"Start Live"})}),e.jsxs("div",{className:"p-3 bg-background rounded border",children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Status:"}),e.jsx("p",{className:"text-sm text-textMuted",children:v}),h&&e.jsx("div",{className:"mt-3 p-2 bg-green-100 dark:bg-green-900/20 rounded",children:e.jsxs("p",{className:"text-sm text-green-700 dark:text-green-300",children:["üü¢ Live broadcast is active! Share this class ID with students: ",e.jsx("strong",{children:l})]})})]})]}),h&&e.jsx("div",{children:e.jsx(W,{})})]})]})}export{q as default};
